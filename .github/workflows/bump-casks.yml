name: Bump casks on schedule

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */4 * * *" # Every 4 hours

permissions:
  contents: write
  pull-requests: write

jobs:
  bump:
    runs-on: ubuntu-latest
    env:
      HOMEBREW_DEVELOPER: 1
      HOMEBREW_NO_AUTO_UPDATE: 1
      HOMEBREW_GITHUB_API_TOKEN: ${{ secrets.PAT_TOKEN }}
      GH_TOKEN: ${{ secrets.PAT_TOKEN }}
    steps:
      - name: Set up Homebrew
        id: set-up-homebrew
        uses: Homebrew/actions/setup-homebrew@master

      - name: Tap repository
        run: brew tap agammemnon/tap

      - name: Configure Git user
        uses: Homebrew/actions/git-user-config@master
        with:
          username: ${{ github.actor }}

      - name: Close stale bump PRs
        run: |
          gh pr list --repo "${{ github.repository }}" --state open --json number,headRefName \
            --jq '.[] | select(.headRefName | startswith("bump-")) | .number' | while read -r pr; do
            echo "Closing stale PR #$pr"
            gh pr close "$pr" --repo "${{ github.repository }}" --delete-branch || true
          done

      - name: Bump outdated casks
        run: brew bump --tap agammemnon/tap --cask --no-fork --open-pr

      - name: Enable auto-merge on bump PRs
        run: |
          gh pr list --repo "${{ github.repository }}" --state open --json number,headRefName \
            --jq '.[] | select(.headRefName | startswith("bump-")) | .number' | while read -r pr; do
            echo "Enabling auto-merge for PR #$pr"
            gh pr merge "$pr" --repo "${{ github.repository }}" --auto --squash || true
          done

  cleanup:
    needs: bump
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Delete stale bump branches
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          git branch -r | grep 'origin/bump-' | sed 's|origin/||' | while read -r branch; do
            PR_STATE=$(gh pr list --repo "${{ github.repository }}" --head "$branch" --state all --json state \
              --jq '.[0].state // empty' 2>/dev/null) || true

            if [ "$PR_STATE" = "MERGED" ] || [ "$PR_STATE" = "CLOSED" ] || [ -z "$PR_STATE" ]; then
              echo "Deleting branch: $branch (${PR_STATE:-orphaned})"
              git push origin --delete "$branch" 2>/dev/null || true
            fi
          done

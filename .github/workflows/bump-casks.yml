name: Bump casks on schedule

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */4 * * *" # Every 4 hours

permissions:
  contents: write
  pull-requests: write

jobs:
  autobump:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        cask:
          - zen-browser-linux
          - google-chrome-linux
          - helium-browser-linux
          - zed-linux
          - zed-linux@preview
          - ghostty-linux
          - antigravity-linux
          - goland-linux
          - intellij-idea-linux
          - cursor-linux
          - rubymine-linux
      fail-fast: false
    env:
      HOMEBREW_DEVELOPER: 1
      HOMEBREW_NO_AUTO_UPDATE: 1
    steps:
      - name: Set up Homebrew
        id: set-up-homebrew
        uses: Homebrew/actions/setup-homebrew@master

      - name: Tap repository
        run: brew tap agammemnon/tap

      - name: Configure Git user
        uses: Homebrew/actions/git-user-config@master
        with:
          username: ${{ github.actor }}

      - name: Bump ${{ matrix.cask }}
        env:
          HOMEBREW_GITHUB_API_TOKEN: ${{ secrets.PAT_TOKEN }}
        continue-on-error: true
        run: |
          echo "Checking ${{ matrix.cask }}..."
          brew bump --no-fork --open-pr --cask "agammemnon/tap/${{ matrix.cask }}"

      - name: Enable auto-merge for created PR
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          PR_NUMBER=$(gh pr list --repo "${{ github.repository }}" --state open --json number,title --jq '.[] | select(.title | test("${{ matrix.cask }}"; "i")) | .number' | head -1)
          if [ -n "$PR_NUMBER" ]; then
            echo "Enabling auto-merge for PR #$PR_NUMBER"
            gh pr merge "$PR_NUMBER" --repo "${{ github.repository }}" --auto --squash
          else
            echo "No open PR found for ${{ matrix.cask }}"
          fi

      - name: Summary
        if: always()
        run: |
          echo "### Cask Bump Result" >> "$GITHUB_STEP_SUMMARY"
          echo "Attempted to bump: \`${{ matrix.cask }}\`" >> "$GITHUB_STEP_SUMMARY"
